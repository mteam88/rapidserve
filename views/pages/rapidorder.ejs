<!DOCTYPE html>
<html>
  <head>
    <%- include('../partials/_head') %>
  </head>
  <body id="grad">
    <div id="sidebar" class="sidebar">
      <span class="sidebar-button" style="position: absolute;top:10px;"><img style="width: 55px;height: 55px;margin: 10px;" src="public/assets/profile-icon.png"><span class="sidebar-text" style="bottom: 22px;color:white">Profile</span></span>
      <span class="sidebar-button" style="position: absolute;top:105px;"><img style="width: 55px;height: 55px;margin: 10px;" src="public/assets/settings-icon.jpg"><span class="sidebar-text" style="bottom: 22px;color:white">Settings</span></span>
      <span class="sidebar-button" style="position: absolute;top:195px;"><img style="width: 55px;height: 55px;margin: 10px;" src="public/assets/favorites-icon.png"><span class="sidebar-text" style="bottom: 22px;color:white">Favorites</span></span>
      <span class="sidebar-button" style="position: absolute;top:285px;"><img style="width: 55px;height: 55px;margin: 10px;" src="public/assets/history-icon.png"><span class="sidebar-text" style="bottom: 22px;color:white">History</span></span>
      <span class="sidebar-button" style="position: absolute;top:375px;"><img style="width: 55px;height: 55px;margin: 10px;" src="public/assets/about-icon.png"><span class="sidebar-text" style="bottom: 22px;color:white">About</span></span>
      <span class="sidebar-button" style="position: absolute;bottom:10px;"><img style="width: 55px;height: 55px;margin: 10px;" src="public/assets/logout-icon.png"><span class="sidebar-text" style="bottom: 22px;color:red">Logout</span></span>
    </div>
    <div id="content" class="content">
      <div class="topnav shadow">
        <a class="navlogospot" href="/"><img class="navlogo" src="/public/assets/Rlogo.png"></img></a>
        <a href="rapidpoll">Poll</a>
        <a class="active" href="rapidorder">Order</a>
        <a href="info">Info</a>
      </div>

      <h1 class="bubbleheader">Rapid Order</h1>

      <p>Input your order, then click "Place Order."</p>
      <button style="float: right;width: 75px" onclick="toghlp()">Help</button>
      <div id="hlptxt" class="bubbleheader">
        <h2 style="text-align: center;">Help</h2>
        <p>
          Select items that you would like to order by clicking on them or tapping them.
          When a box is next to the selection, you can choose multiple items.
          If you want to change your selection, click or tap on the item that you currently have selected.
          Then, click or tap on your new item.
          When you are satisfied with your selections, click on or tap the "Place Order" button.
  
          If you still need help, contact us or tell your teacher.
        </p>
      </div>

      <div id=orderstuff>
        <!-- <form action="/rapidorder" method="POST">
          <label for="body">orderBody</label>
          <textarea id="body" name="orderBody" required></textarea>
          <button>Submit</button>
        </form> -->
        
        
       <table id="ordertable">
          
        </table>
        <button id='submitButton' style="float: right;">Place Order</button>
      </div>
      <image src="/public/assets/Rlogo.png" id="bottomof"></image>
    </div>
    <script src="/public/js/sidebar.js"></script>
    <script>
      var urlParameters = new URLSearchParams(window.location.search);
      var outputBinary = [];

      var menuCheck = window.setInterval(CreateMenu, 100);
      const submitButton = document.getElementById('submitButton');
      submitButton.addEventListener('click', (e) => {
        const endpoint = 'rapidorder/';
        
        output = outputBinary.join('');
        var orderBody = output;
        var formatted = [];
        var encodedKey = encodeURIComponent('orderBody');
        var encodedValue = encodeURIComponent(output);
        formatted.push(encodedKey + "=" + encodedValue);
        //alert(formatted);
        fetch(endpoint, {
          method: 'POST',
          headers: {
            //'Content-Type': 'application/json'
            'Accept': 'application/json',
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formatted
        })
        .then(response => response.json())
            .then((data) => {
              if (data.status == 'success') {
                sessionStorage.removeItem("orderPreset");
                plcordr();
              }
        })
        .catch((err) => {alert(err)})
      });

      function CreateMenu() {
        if (menuObject) {
          clearInterval(menuCheck);
          var orderPreset = sessionStorage.getItem("orderPreset");
          if (!orderPreset) {
            orderPreset = "0";
          }
          if (urlParameters.has("order")) {
            orderPreset = urlParameters.get("order");
          }
          orderPreset = orderPreset.split("");
          outputBinary = orderPreset;
          var loopAmount = 0;
          var tableRow = document.createElement("tr");
          tableRow.id = "menu-row0";
          for (var [key, value] of Object.entries(menuObject)) {
            if (value.length + 1 > loopAmount) {
              loopAmount = value.length + 1;
            }
            var rowCell = document.createElement("th");
            rowCell.innerHTML = key.replace(/_/g,"");
            tableRow.appendChild(rowCell);
          }
          document.getElementById("ordertable").appendChild(tableRow);
          for (var i = 0;i < loopAmount;i++) {
            if (i == 0) {
              continue;
            }
            var tableRow = document.createElement("tr");
            tableRow.id = "menu-row" + (1 + i);
            var k = 0;
            for (var [key, value] of Object.entries(menuObject)) {
              var rowCell = document.createElement("td");
              if (value.length >= i) {
                rowCell.classList.add("selectable");
                rowCell.innerHTML = value[i - 1];
                if (orderPreset[(i - 1) * Object.keys(menuObject).length + k] == 1) {
                  rowCell.style.backgroundColor = "red";
                }
                rowCell.number = (i - 1) * Object.keys(menuObject).length + k;
                rowCell.onclick = function() {changebg(this);outputBinary[this.number] = (this.style.backgroundColor == "red") ? 1 : 0;sessionStorage.setItem("orderPreset", outputBinary.join(""));};
                tableRow.appendChild(rowCell);
              }
              tableRow.appendChild(rowCell);
              k += 1;
            }
            document.getElementById("ordertable").appendChild(tableRow);
          }
          sessionStorage.setItem("orderPreset", outputBinary.join(""));
        }
      }
    </script>
  </body>
</html>